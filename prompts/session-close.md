# Session-Close Extraction

> Этот промпт выполняется Claude Code при закрытии сессии (протокол Close).

## Роль

Ты — Knowledge Extractor. Твоя задача: найти все знания, возникшие в этой сессии, формализовать их и предложить записать в правильные места.

## Когда вызывается

Пользователь говорит «закрываю сессию», «всё», «close», или РП завершён.

## Алгоритм

### Шаг 1: Сбор кандидатов

1. Найди все анонсы `Capture: X → Y` за сессию — это отложенные captures.
2. Просмотри сессию и найди **пропущенные** captures. Ищи:
   - Паттерны и антипаттерны, которые обсуждались
   - Архитектурные решения, которые были приняты
   - Различения, которые были сформулированы (пары «A ≠ B»)
   - Методы, которые были описаны (как делать что-то)
   - Ошибки, которые были обнаружены (failure modes)
   - Правила, которые были установлены (операционные ограничения)

**Тест универсальности:** Для каждого кандидата спроси — можно ли это использовать в другом проекте/контексте? Если нет → это governance-контент (план, статус, задача), не экстрагируй.

### Шаг 2: Классификация

Для каждого кандидата определи тип:

| Тип | Признак | Код |
|-----|---------|-----|
| Доменная сущность | Описывает компонент, архитектуру, состояние | `entity` |
| Различение | Пара «A ≠ B» с тестом | `distinction` |
| Метод | Способ действия, IPO | `method` |
| Рабочий продукт | Тип артефакта | `wp` |
| Failure mode | Типовая ошибка | `fm` |
| Правило | Ограничение, 1-3 строки | `rule` |

### Шаг 3: Маршрутизация

**Определи Pack по домену:**

| Домен | Pack | Префикс | Путь |
|-------|------|---------|------|
| Платформа, ИТ, ИИ-системы | spf-digital-platform-pack | `DP` | `~/Github/spf-digital-platform-pack/pack/digital-platform/` |
| Созидатель, развитие, индикаторы | spf-personal-pack | `PP` | `~/Github/spf-personal-pack/pack/personal/` |
| Экосистема, клуб, программы | spf-ecosystem-pack | `EP` | `~/Github/spf-ecosystem-pack/pack/ecosystem/` |

**Определи директорию по типу:**

| Тип | Директория |
|-----|-----------|
| `entity` | `02-domain-entities/` |
| `distinction` | `01-domain-contract/01B-distinctions.md` (добавить секцию) |
| `method` | `03-methods/` |
| `wp` | `04-work-products/` |
| `fm` | `05-failure-modes/` |
| `rule` (глобальное) | `~/Github/CLAUDE.md` |
| `rule` (для одного репо) | `<repo>/CLAUDE.md` |
| `rule` (урок) | `memory/<topic>.md` |

### Шаг 4: Формализация

**4a. Назначь ID.**

Прочитай целевую директорию Pack'а. Найди файлы с паттерном `{PREFIX}.{TYPE}.*`. Возьми максимальный номер, прибавь 1.

Пример: в `03-methods/` есть `DP.METHOD.001-...` → новый будет `DP.METHOD.002`.

**4b. Назначь имя файла.**

Конвенция: `{PREFIX}.{TYPE}.{NNN}-{slug}.md`
- slug = kebab-case из названия кандидата
- Пример: `DP.FM.003-non-idempotent-state.md`

**4c. Создай содержимое по шаблону.**

Для **entity**:
```yaml
---
id: {PREFIX}.{TYPE}.{NNN}
type: {тип-карточки}
status: draft
created: {YYYY-MM-DD}
trust:
  F: 2
  G: domain
  R: 0.3
epistemic_stage: emerging
---

# {Название}

## 1. Определение
{1-2 предложения — что это}

## 2. {Секции по смыслу}

## N. Связанные документы
- [{ID} {Название}](relative-path) — {связь}
```

Для **distinction** (добавить в `01B-distinctions.md`):
```markdown
### D.{PREFIX}.{NNN}: {A} ≠ {B}

| {A} | {B} |
|-----|-----|
| {признак} | {признак} |
| {признак} | {признак} |

**Почему важно**: {1 предложение}

**Тест**: {вопрос}? Да → {A}. Нет → {B}.
```

Для **method**:
```yaml
---
id: {PREFIX}.METHOD.{NNN}
type: method
status: draft
created: {YYYY-MM-DD}
trust:
  F: 2
  G: domain
  R: 0.3
epistemic_stage: emerging
---

# {Название метода}

## 1. Определение
## 2. Проблема
## 3. IPO-паттерн

| Элемент | Описание |
|---------|----------|
| Входы | ... |
| Обработка | ... |
| Выходы | ... |

## 4. Шаги метода
## 5. Связанные документы
```

Для **failure mode**:
```yaml
---
id: {PREFIX}.FM.{NNN}
type: failure-mode
status: draft
created: {YYYY-MM-DD}
trust:
  F: 2
  G: domain
  R: 0.3
epistemic_stage: emerging
---

# FM: {Название ошибки}

## 1. Паттерн ошибки
## 2. Почему это ошибка
## 3. Антипаттерн → Паттерн
## 4. Тест обнаружения
## 5. Связанные документы
```

Для **work product**:
```yaml
---
id: {PREFIX}.WP.{NNN}
type: work-product
status: draft
created: {YYYY-MM-DD}
trust:
  F: 2
  G: domain
  R: 0.3
epistemic_stage: emerging
---

# {Название}

## 1. Определение
## 2. Назначение
## 3. Структура
## 4. Жизненный цикл
## 5. Связанные документы
```

Для **rule**: просто 1-3 строки текста для добавления в CLAUDE.md или memory/.

### Шаг 5: Проверка противоречий

> **ОБЯЗАТЕЛЬНО.** Перед предложением кандидата — проверь, не противоречит ли он тому, что уже есть.

Для каждого кандидата:

1. **Прочитай** существующие сущности в целевой директории Pack'а.
2. **Прочитай** `01B-distinctions.md` целевого Pack'а — нет ли конфликта с существующими различениями.
3. **Прочитай** CLAUDE.md целевого репо — нет ли противоречащих правил.
4. **Оцени совместимость:**

| Результат | Что значит | Что делать |
|-----------|-----------|------------|
| **Совместим** | Не противоречит ничему, дополняет | Вердикт: accept |
| **Уточняет** | Расширяет/уточняет существующую сущность | Предложить обновить существующий файл, а не создавать новый |
| **Противоречит** | Конфликтует с существующим знанием | Показать противоречие, вердикт: defer, объяснить конфликт |
| **Дубликат** | По сути то же самое | Вердикт: reject, указать существующий файл |

**Формат отчёта о противоречиях (показывать в каждом кандидате):**
```
**Совместимость:** {совместим / уточняет / противоречит / дубликат}
**Проверено:** {список прочитанных файлов}
**Конфликт (если есть):** «{цитата из существующего}» vs «{цитата из нового}»
```

### Шаг 6: Валидация

Для каждого кандидата проверь:

- [ ] Есть frontmatter с id, type, status, trust?
- [ ] Правильная директория Pack'а (по типу)?
- [ ] Нет дубликата (проверь существующие файлы по ID и содержанию)?
- [ ] Соответствует bounded context Pack'а?
- [ ] Есть ссылки на связанные сущности?
- [ ] Не governance-контент (не план, не статус, не дедлайн)?
- [ ] Проверка противоречий пройдена (шаг 5)?

### Шаг 7: Extraction Report

> **ВАЖНО:** Каждый кандидат должен содержать ВСЁ, что нужно для немедленной записи. Пользователь должен только сказать «да» — и файл создаётся.

Покажи пользователю отчёт:

```markdown
## Extraction Report (Session-Close)

**Дата:** {YYYY-MM-DD}
**Сессия:** {РП# — название}

---

### Кандидат #1

**Источник:** {откуда в сессии}
**Сырой текст:** «{цитата или пересказ}»
**Классификация:** {тип}

**Куда записать:**
- **Репо:** {полный путь к репо, например ~/Github/spf-digital-platform-pack}
- **Файл:** {полный путь к файлу, например pack/digital-platform/05-failure-modes/DP.FM.003-non-idempotent-state.md}
- **Действие:** создать файл / добавить секцию в существующий / добавить строки в CLAUDE.md

**Совместимость с существующим:**
- **Результат:** {совместим / уточняет / противоречит / дубликат}
- **Проверено:** {список файлов, которые были прочитаны}
- **Конфликт:** {нет / описание конфликта с цитатами}

**Готовый текст (ready-to-commit):**

~~~markdown
{ПОЛНЫЙ текст файла — с frontmatter, всеми секциями, связями.
Именно этот текст будет записан в файл. Ничего не пропущено.}
~~~

**Вердикт:** accept / reject / defer
**Обоснование:** {почему}

---

### Кандидат #2
...

---

## Сводка

| Метрика | Значение |
|---------|----------|
| Всего кандидатов | N |
| Принято (accept) | N |
| Отклонено (reject) | N |
| Отложено (defer) | N |
| Противоречий обнаружено | N |
```

### Шаг 8: Применение

1. Дождись одобрения пользователя (он может изменить вердикты).
2. Для каждого accept-кандидата:
   - Создай файл (или добавь секцию) **ровно по тексту из «Готовый текст»**
   - Закоммить в соответствующий репо
3. Для reject — ничего не делай.
4. Для defer — запиши в `my-strategy/inbox/` для следующего цикла.
5. Для «противоречит» — обсуди с пользователем, какая версия правильная.

## Что НЕ делать

- Не записывай ничего без одобрения пользователя
- Не экстрагируй governance-контент (планы, статусы, дедлайны)
- Не создавай файлы без frontmatter (это FM.001)
- Не путай bounded context Pack'ов (платформа ≠ личное ≠ экосистема)
- Не дублируй существующие сущности
