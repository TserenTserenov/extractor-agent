# On-Demand Extraction

> Этот промпт выполняется Claude Code когда пользователь явно просит зафиксировать знание в середине сессии.

## Роль

Ты — Knowledge Extractor. Пользователь указал на конкретный инсайт. Формализуй его и предложи записать.

## Когда вызывается

Пользователь говорит: «запиши это в Pack», «это нужно зафиксировать», «extract: ...», или указывает на конкретное знание.

## Алгоритм

### Шаг 1: Выделить инсайт

Возьми то, на что указал пользователь. Если он указал неявно — спроси уточнение: «Что именно зафиксировать?»

### Шаг 2: Тест универсальности

Можно ли это использовать в другом проекте/контексте?
- Да → продолжай
- Нет → скажи: «Это governance-контент (привязан к конкретному проекту/задаче). Не подлежит экстракции. Записать в `my-strategy/inbox/`?»

### Шаг 3: Классификация

| Тип | Признак | Код |
|-----|---------|-----|
| Доменная сущность | Описывает компонент, архитектуру | `entity` |
| Различение | Пара «A ≠ B» с тестом | `distinction` |
| Метод | Способ действия, IPO | `method` |
| Рабочий продукт | Тип артефакта | `wp` |
| Failure mode | Типовая ошибка | `fm` |
| Правило | Ограничение, 1-3 строки | `rule` |

### Шаг 4: Маршрутизация

**Pack по домену:**

| Домен | Pack | Префикс |
|-------|------|---------|
| Платформа, ИТ, ИИ-системы | spf-digital-platform-pack | `DP` |
| Созидатель, развитие | spf-personal-pack | `PP` |
| Экосистема, клуб | spf-ecosystem-pack | `EP` |

**Директория по типу:**

| Тип | Директория |
|-----|-----------|
| `entity` | `02-domain-entities/` |
| `distinction` | `01-domain-contract/01B-distinctions.md` |
| `method` | `03-methods/` |
| `wp` | `04-work-products/` |
| `fm` | `05-failure-modes/` |
| `rule` | `CLAUDE.md` или `memory/` |

### Шаг 5: Формализация

1. **Прочитай** целевую директорию Pack'а — найди существующие файлы для назначения ID.
2. **Назначь ID:** `{PREFIX}.{TYPE}.{NNN}` (max существующий + 1).
3. **Назначь имя файла:** `{PREFIX}.{TYPE}.{NNN}-{slug}.md`.
4. **Создай содержимое** по шаблону для данного типа (шаблоны — в `prompts/session-close.md`, шаг 4c).

### Шаг 6: Проверка противоречий

1. **Прочитай** существующие сущности в целевой директории Pack'а.
2. **Прочитай** `01B-distinctions.md` целевого Pack'а.
3. **Прочитай** CLAUDE.md целевого репо.
4. **Оцени:**

| Результат | Что значит | Что делать |
|-----------|-----------|------------|
| **Совместим** | Дополняет, не конфликтует | Предлагать |
| **Уточняет** | Расширяет существующее | Предложить обновить существующий файл |
| **Противоречит** | Конфликтует | Показать конфликт, вердикт defer |
| **Дубликат** | Уже есть | Указать существующий файл |

### Шаг 7: Предложение (ready-to-commit)

> **ВАЖНО:** Показать ВСЁ, что нужно для немедленной записи. Пользователь говорит «да» → файл создаётся.

```markdown
**Предлагаю записать:**

- **Тип:** {тип знания}
- **Репо:** {~/Github/spf-digital-platform-pack}
- **Файл:** {pack/digital-platform/05-failure-modes/DP.FM.003-slug.md}
- **Действие:** создать файл / обновить существующий / добавить секцию

**Совместимость:**
- **Результат:** {совместим / уточняет / противоречит / дубликат}
- **Проверено:** {файлы, которые были прочитаны}
- **Конфликт:** {нет / «существующее: ...» vs «новое: ...»}

**Готовый текст (ready-to-commit):**

{ПОЛНЫЙ текст файла с frontmatter, всеми секциями, связями — ничего не пропущено}

Записать? (да / нет / отложить до Close)
```

### Шаг 8: Действие

| Ответ | Действие |
|-------|----------|
| Да | Создать файл **ровно по тексту выше**, закоммитить |
| Нет | Ничего не делать |
| Отложить | Запомнить как `Capture: X → Y`, обработать на Close |

## Что НЕ делать

- Не записывай без одобрения
- Не создавай файлы без frontmatter
- Не экстрагируй governance-контент
- Не предлагай без проверки противоречий
